name: Release Creation on GitHub & NPM Publishing

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  check_conditions:
    name: Check conditions to create & publish a release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.check_workflow_conditions.outputs.version }}
    steps:
      - name: Checkout the Codebase
        uses: actions/checkout@v4
        with:
          # ref: main # branch to checkout, but we use the provided branch by the event
          fetch-depth: 0

      # - name: Get `package.json` version
      #   id: get_package_version
      #   run: echo version=$(node -p "require('./package.json').version") >> $GITHUB_OUTPUT
        
      - name: Check first line of commit message and search for commands `[rel-TYPE-CHANGELOG]`
        id: check_workflow_conditions
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs').promises

            const versionRegex = "\\d+\\.\\d+\\.\\d+(-rc\\.\\d+)?" // allowed: `1.0.0`, `1.0.0-rc.1`
            
            // ==== commit message ====

            // Get first line of last commit message
            const lastCommitMessage = context?.payload?.head_commit.message ?? context?.payload?.commits[0]?.message
            const lastCommitMessageFirstLine = lastCommitMessage?.split('\n')[0] ?? ''

            const regex_commitMessage = new RegExp(`^chore\(release\): v(${versionRegex}) \(#\d+\)$`, "g")
            const match_commitMessage = lastCommitMessageFirstLine.match(regex_commitMessage)

            if (!match_commitMessage) {
              throw new Error(`Invalid commit message: ${lastCommitMessageFirstLine}`)
            }

            const version_byCommitMessage = match_commitMessage[1]

            // ==== version in `package.json` ====

            const packageJson = await fs.readFile('package.json', 'utf8')
            const { version: version_byPackageJson } = JSON.parse(packageJson)

            const regex_packageJson = new RegExp(`^(${versionRegex})$`, "g")
            const match_packageJson = lastPackageJsonFirstLine.match(regex_packageJson)

            if (!match_packageJson) {
              throw new Error(`Invalid version in package.json: ${version_byPackageJson}`)
            }

            // ==== compare all versions ====

            if (version_byCommitMessage !== version_byPackageJson) {
              throw new Error(`Versions are not equal: ${version_byCommitMessage} (commit message) !== ${version_byPackageJson} (package.json)`)
            }

            // the versions are equal, so just take one of them
            const version = version_byCommitMessage

            // ==== set outputs ====

            console.dir(`Set output: version=${version}`)
            core.setOutput("version", version)

  dependence-lint:
    name: Depend on Lint
    uses: ./.github/workflows/lint.yml

  create_release:
    needs:
      - check_conditions
      - dependence-lint
    # if: needs.check_conditions.outputs.do_release == 'true'
    name: Create GitHub Release & NPM Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout the Codebase
        uses: actions/checkout@v4
        with:
          ref: main # branch to checkout
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable pnpm
        run: |
          corepack enable
          corepack prepare pnpm@v9.15.4 --activate

      - name: Init git config for the bot by setting name & email
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "no-reply@todde.tv"

      # do all code related stuff early to catch if something is wrong and it fails
      # TODO create a workflow like `Lint` to test install by lockfile and build

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build the project
        run: pnpm run build

      - name: Create a tag
        run: |
          git tag -a "v${{ needs.check_conditions.outputs.version }}" -m "Release v${{ needs.check_conditions.outputs.version }}"
          git push origin --tags

      - name: Sync tags with GitHub releases & create the new release
        # run: pnpm changelogen gh release all
        run: pnpm changelogen gh release "v${{ needs.check_conditions.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # # pack the project in a archive for publishing, e.g. `todde.tv-gltf-type-toolkit-1.0.0.tgz`
      # - name: Pack the project
      #   run: pnpm pack

      # - name: Publish package to NPM
      #   if: github.ref == 'refs/heads/main'
      #   run: pnpm publish --access public
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish package to NPM
        # if: github.ref == 'refs/heads/main'
        uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          access: public
          # registry: "https://npm.pkg.github.com/"
          registry: https://registry.npmjs.org/
